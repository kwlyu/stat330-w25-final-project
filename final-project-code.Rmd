---
title: "Final Project Code"
author: "Kunwu Lyu and Evan Hart"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE, cache=TRUE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lme4)
library(ordinal)
library(VGAM)
library(optimx)
library(car)
```

## Data Wrangling

```{r}
survey <- read_tsv("data/ICPSR_37143/DS0001/37143-0001-Data.tsv")
receipt <- read_tsv("data/ICPSR_37143/DS0002/37143-0002-Data.tsv")
fast_food <- read_tsv("data/ICPSR_37143/DS0003/37143-0003-Data.tsv")
grocery <- read_tsv("data/ICPSR_37143/DS0004/37143-0004-Data.tsv")
recall <- read_tsv("data/ICPSR_37143/DS0005/37143-0005-Data.tsv")

full_data <- survey %>%
  full_join(receipt, relationship = "many-to-many") %>%  
  full_join(fast_food, relationship = "many-to-many") %>%
  full_join(grocery, relationship = "many-to-many") %>%
  full_join(recall, relationship = "many-to-many") %>% 
  janitor::clean_names()

full_data <- full_data %>% 
  mutate(limit = ordered(q75, levels = c("Never", "Seldom", "Sometimes", "Often", "Always"))) %>% 
  mutate(age = as.numeric(q76) - mean(as.numeric(76)),
         gender = if_else(q77 == 0, "M", "F"),
         race = case_when(
           !is.na(q79_1) ~ "Native",
           !is.na(q79_2) ~ "Black",
           !is.na(q79_3) ~ "Asian",
           !is.na(q79_4) ~ "White",
           !is.na(q79_a) ~ "Other"
         ),
         edu = as.numeric(q80),
         location = nemslocationindicator,
         city = q1,
         num_kids = q44)

diet_unsweetened_cols <- data_names[str_detect(colnames(full_data), pattern = "diet|unsweetened")]
reduced_data <- full_data %>% 
  mutate(diet = if_else(rowSums(select(., all_of(diet_unsweetened_cols)) %>% 
                               mutate(across(everything(), as.numeric)), na.rm = TRUE) >= 1, 1, 0)) %>% 
  select(c("limit","age", "gender", "race", "edu", "city", "caff", "location", "round", "nsigns_ssb", "num_kids", "diet")) %>% 
  drop_na()

write_csv(reduced_data, "dietControl.csv")
```


### Kunwu's section

```{r cache=TRUE}
control_clm <- clm(limit ~ age + gender + race + edu + city + caff, data = full_data, control = list(
  maxIter = 10000, 
  maxLineIter = 2000, 
  maxModIter = 2000, 
  method = "Newton", 
  trace = 1))
control_clm <- clm(limit ~ age + gender + race + edu + city + caff, data = full_data, control = list(
  method = "ucminf",
  stepmax = 1,
  grad = "central",
  maxeval = 500000,
  gradstep = c(1e-10, 1e-12),
  trace = 1))
control_clm <- clm(limit ~ age + gender + race + edu + city + caff, data = full_data, control = list(
  method = "nlminb",
  eval.max = 2000,
  iter.max = 1500,
  abs.tol = 1e-20,
  trace = 1))
control_clm <- clm(limit ~ age + gender + race + edu + city + caff, data = full_data, control = list(
  method = "optim",
  tmax = 100,
  maxit = 100000,
  type = 1,
  ndeps = 1e-10,
  REPORT = 1,
  trace = 1))
control_vglm <- vglm(limit ~ age + gender + race + edu + city + caff, 
                     data = full_data, family = cumulative(parallel = TRUE))
control_clmm <- clmm(limit ~ 1 + age + gender + race + edu + city + caff + (1 | location) + (1 | round), control = list(trace = 1),
                     data = full_data, link = "logit")

summary(control_clm)
summary(control_vglm)
coef(control_vglm, matrix = T)
summary(control_clmm)
coef(control_clmm, matrix = T)


## fine
```










```{r Backward and Forward Selection, cache=TRUE, message=FALSE, warning=FALSE}
set.seed(67393937)

upper_model <- clm(limit ~ .,
                 data = full_data)
lower_model <- clm(limit ~ 1, data = full_data)

# #backward selection
# backwardSelectModel <- stepAIC(upper_model, scope = list(lower = lower_model, 
#                                                          upper = upper_model),
#                                direction = "backward")
# summary(backwardSelectModel)

#forward selection
forwardSelectModel <- stepAIC(lower_model, scope = list(lower = lower_model, 
                                                         upper = upper_model),
                               direction = "forward")
summary(forwardSelectModel)


```




### Evan's section

```{r}
# EDA vars: diet/unsweetened
# nsigns_ssb is advertisement count for sugary beverages
# q44 is mutated to num_kids

names(full_data)[which(names(full_data) == "q44")] <- "num_kids"

reduced_data <- full_data[, which(names(full_data) %in% c("limit","age", "gender", "race", "edu", "city", "caff", "location", "round", "nsigns_ssb", "num_kids"))]


```

```{r}
ggplot(data = na.omit(reduced_data), aes(x = age , y = limit)) + 
  geom_boxplot() +
  labs(x = "age", y = "limit")

ggplot(data = na.omit(reduced_data), aes(x = race, fill = limit)) +
  geom_bar(position = "fill") + 
  scale_y_continuous(labels = scales::percent) + 
  labs(x = "Race", y = "Percentage", fill = "Limit") +
  theme_minimal()

ggplot(data = na.omit(reduced_data), aes(x = num_kids, fill = limit)) +
  geom_bar(position = "fill") + 
  scale_y_continuous(labels = scales::percent) + 
  labs(x = "Child Count", y = "Percentage", fill = "Limit") +
  theme_minimal()

ggplot(data = na.omit(reduced_data), aes(x = edu, fill = limit)) +
  geom_bar(position = "fill") + 
  scale_y_continuous(labels = scales::percent) + 
  labs(x = "Education", y = "Percentage", fill = "Limit") +
  theme_minimal()
```





