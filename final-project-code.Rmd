---
title: "Final Project Code"
author: "Kunwu Lyu and Evan Hart"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE, cache=TRUE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lme4)
library(ordinal)
library(VGAM)
```

## Data Wrangling

```{r}
survey <- read_tsv("data/ICPSR_37143/DS0001/37143-0001-Data.tsv")
receipt <- read_tsv("data/ICPSR_37143/DS0002/37143-0002-Data.tsv")
fast_food <- read_tsv("data/ICPSR_37143/DS0003/37143-0003-Data.tsv")
grocery <- read_tsv("data/ICPSR_37143/DS0004/37143-0004-Data.tsv")
recall <- read_tsv("data/ICPSR_37143/DS0005/37143-0005-Data.tsv")

full_data <- survey %>%
  full_join(receipt, relationship = "many-to-many") %>%  
  full_join(fast_food, relationship = "many-to-many") %>%
  full_join(grocery, relationship = "many-to-many") %>%
  full_join(recall, relationship = "many-to-many") %>% 
  janitor::clean_names()

full_data <- full_data %>% 
  mutate(limit = as.factor(q75)) %>% 
  mutate(limit = fct_relevel(limit, "Never", "Seldom", "Sometimes", "Often", "Always"))
```


### Kunwu's section

```{r cache=TRUE}
full_data <- full_data %>% 
  mutate(age = as.numeric(q76) - mean(as.numeric(76)),
         gender = if_else(q77 == 0, "M", "F"),
         race = case_when(
           !is.na(q79_1) ~ "Native",
           !is.na(q79_2) ~ "Black",
           !is.na(q79_3) ~ "Asian",
           !is.na(q79_4) ~ "White",
           !is.na(q79_a) ~ "Other"
         ),
         edu = as.numeric(q80),
         location = nemslocationindicator,
         city = q1)
control_clmm <- clmm(limit ~ 1 + age + gender + race + edu + city + caff + (1 | location) + (1 | round), data = full_data)

summary(control_clmm)
```



```{r Backward and Forward Selection, cache=TRUE, message=FALSE, warning=FALSE}
set.seed(67393937)

upper_model <- clm(limit ~ .,
                 data = full_data)
lower_model <- clm(limit ~ 1, data = full_data)

# #backward selection
# backwardSelectModel <- stepAIC(upper_model, scope = list(lower = lower_model, 
#                                                          upper = upper_model),
#                                direction = "backward")
# summary(backwardSelectModel)

#forward selection
forwardSelectModel <- stepAIC(lower_model, scope = list(lower = lower_model, 
                                                         upper = upper_model),
                               direction = "forward")
summary(forwardSelectModel)


```




### Evan's section

