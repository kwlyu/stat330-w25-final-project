---
title: "Final Project Code"
author: "Kunwu Lyu and Evan Hart"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE, cache=TRUE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lme4)
library(ordinal)
library(VGAM)
library(optimx)
library(MASS)
library(car)
```

## Data Wrangling

```{r}
survey <- read_tsv("data/ICPSR_37143/DS0001/37143-0001-Data.tsv") %>%
  janitor::clean_names()
receipt <- read_tsv("data/ICPSR_37143/DS0002/37143-0002-Data.tsv") %>%
  janitor::clean_names()
fast_food <- read_tsv("data/ICPSR_37143/DS0003/37143-0003-Data.tsv") %>%
  janitor::clean_names()
grocery <- read_tsv("data/ICPSR_37143/DS0004/37143-0004-Data.tsv") %>%
  janitor::clean_names()
recall <- read_tsv("data/ICPSR_37143/DS0005/37143-0005-Data.tsv") %>%
  janitor::clean_names()

full_data <- survey %>%
  full_join(receipt, relationship = "many-to-many") %>%  
  full_join(fast_food, relationship = "many-to-many") %>%
  full_join(grocery, relationship = "many-to-many") %>%
  full_join(recall, relationship = "many-to-many") 

diet_unsweetened_cols <- survey %>%
  select(where(~ any(str_detect(as.character(.), "diet|unsweetened"), na.rm = TRUE))) %>%
  colnames()

full_data <- full_data %>% 
  mutate(limit = ordered(q75, levels = c("Never", "Seldom", "Sometimes", "Often", "Always"))) %>% 
  mutate(age = as.numeric(q76) - mean(as.numeric(76)),
         gender = if_else(q77 == 0, "M", "F"),
         race = case_when(
           !is.na(q79_1) ~ "Native",
           !is.na(q79_2) ~ "Black",
           !is.na(q79_3) ~ "Asian",
           !is.na(q79_4) ~ "White",
           !is.na(q79_a) ~ "Other"
         ),
         edu = as.numeric(q80),
         location = nemslocationindicator,
         city = q1,
         num_kids = q44,
         surveydate = dmy(surveydate)) %>%
  mutate(days_since_ban = as.numeric(interval(as.Date("2013-03-12"), surveydate) / days(1))) %>% 
  mutate(diet = if_else(
    rowSums(select(., all_of(diet_unsweetened_cols)) %>% 
              mutate(across(everything(), ~ str_detect(as.character(.), "diet|unsweetened"))), na.rm = TRUE) >= 1, 
    1, 0
  ))


reduced_data <- full_data %>% 
  select(c("receiptid", "person_id", "limit","age", "gender", "race", "edu", "city", "caff", "location", "round", "nsigns_ssb", "num_kids", "diet", "surveydate", "days_since_ban", "")) %>%
  group_by(receiptid) %>% 
  mutate(caff = mean(caff, na.rm = T)) %>% 
  drop_na() %>% 
  distinct()

write_csv(reduced_data, "dietControl.csv")
```


### Kunwu's section

```{r Optimization Methods, cache=TRUE, eval=FALSE}
control_clm <- clm(limit ~ age + gender + race + edu + city + caff, data = full_data, control = list(
  maxIter = 10000, 
  maxLineIter = 2000, 
  maxModIter = 2000, 
  method = "Newton", 
  trace = 1))
control_clm <- clm(limit ~ age + gender + race + edu + city + caff, data = full_data, control = list(
  method = "ucminf",
  stepmax = 1,
  grad = "central",
  maxeval = 500000,
  gradstep = c(1e-10, 1e-12),
  trace = 1))
control_clm <- clm(limit ~ age + gender + race + edu + city + caff, data = full_data, control = list(
  method = "nlminb",
  eval.max = 2000,
  iter.max = 1500,
  abs.tol = 1e-20,
  trace = 1))
control_clm <- clm(limit ~ age + gender + race + edu + city + caff, data = full_data, control = list(
  method = "optim",
  tmax = 100,
  maxit = 100000,
  type = 1,
  ndeps = 1e-10,
  REPORT = 1,
  trace = 1))
control_vglm <- vglm(limit ~ age + gender + race + edu + city + caff, 
                     data = full_data, family = cumulative(parallel = TRUE))
control_clmm <- clmm(limit ~ 1 + age + gender + race + edu + city + caff + (1 | location) + (1 | round), control = list(trace = 1),
                     data = full_data, link = "logit")

summary(control_clm)
summary(control_vglm)
coef(control_vglm, matrix = T)
summary(control_clmm)
coef(control_clmm, matrix = T)


## fine
```


```{r Backward and Forward Selection, eval=FALSE, cache=TRUE, message=FALSE, warning=FALSE}
set.seed(67393937)

upper_model <- clm(limit ~ (age + gender + race + edu + caff + nsigns_ssb + num_kids + diet + days_since_ban)^2,
                     data = reduced_data, link = "logit")
lower_model <- clm(limit ~ 1, 
                     data = reduced_data, link = "logit")

#backward selection
backwardSelectModel <- stepAIC(upper_model, scope = list(lower = lower_model,
                                                         upper = upper_model),
                               direction = "backward")
summary(backwardSelectModel)

#forward selection
forwardSelectModel <- stepAIC(lower_model, scope = list(lower = lower_model, 
                                                         upper = upper_model),
                               direction = "forward")
summary(forwardSelectModel)
```


```{r}
control_clmm_full <- clmm(limit ~ 1 + age + gender + race + edu + caff + nsigns_ssb + num_kids + diet + days_since_ban + (1 | location) + (1 | round), 
                          control = list(method = "nlminb",
                                         useMatrix = T,
                                         maxIter = 200, 
                                         gradTol = 1e-4, 
                                         maxLineIter = 200,
                                         trace = 1),
                     data = reduced_data, link = "logit")

summary(control_clmm_full)

control_clmm_red <- clmm(limit ~ 1 + age + gender + race + edu + caff + nsigns_ssb + num_kids + (1 | location) + (1 | round), control = list(trace = 1),
                     data = reduced_data, link = "logit")
anova(control_clmm_red, control_clmm_full)


control_clmm_loc <- clmm(limit ~ 1 + age + gender + race + edu + caff + nsigns_ssb + num_kids + (1 | location), control = list(trace = 1),
                     data = reduced_data, link = "logit")

lrt_obs <- as.numeric(2*(logLik(control_clmm_red) - logLik(control_clmm_loc)))
.5*(1 - pchisq(lrt_obs, 0)) + .5*(1 - pchisq(lrt_obs, 1))

control_clmm_rnd <- clmm(limit ~ 1 + age + gender + race + edu + caff + nsigns_ssb + num_kids + (1 | round), control = list(trace = 1),
                     data = reduced_data, link = "logit")
lrt_obs <- as.numeric(2*(logLik(control_clmm_red) - logLik(control_clmm_rnd)))
.5*(1 - pchisq(lrt_obs, 0)) + .5*(1 - pchisq(lrt_obs, 1))

multi_round_locations <- reduced_data %>%
  group_by(receiptid) %>% 
  summarize(n_rounds = n_distinct(person_id)) %>% 
  filter(n_rounds > 1) %>%
  pull(receiptid)

multi_round_locations

reduced_data %>%
  filter(receiptid %in% multi_round_locations) %>%
  count(receiptid, person_id)
```



### Evan's section

```{r}
# EDA vars: diet/unsweetened
# nsigns_ssb is advertisement count for sugary beverages
# q44 is mutated to num_kids

names(full_data)[which(names(full_data) == "q44")] <- "num_kids"

reduced_data <- full_data[, which(names(full_data) %in% c("limit","age", "gender", "race", "edu", "city", "caff", "location", "round", "nsigns_ssb", "num_kids"))]


```

```{r}
ggplot(data = na.omit(reduced_data), aes(x = age , y = limit)) + 
  geom_boxplot() +
  labs(x = "age", y = "Limit")

ggplot(data = na.omit(reduced_data), aes(x = num_kids, fill = limit)) +
  geom_bar(position = "fill") + 
  scale_y_continuous(labels = scales::percent) + 
  labs(x = "Child Count", y = "Percentage", fill = "Limit") +
  theme_minimal()

ggplot(data = na.omit(reduced_data), aes(x = race, fill = limit)) +
  geom_bar(position = "fill") + 
  scale_y_continuous(labels = scales::percent) + 
  labs(x = "Race", y = "Percentage", fill = "Limit") +
  theme_minimal()


ggplot(data = na.omit(reduced_data), aes(x = edu, fill = limit)) +
  geom_bar(position = "fill") + 
  scale_y_continuous(labels = scales::percent) + 
  labs(x = "Education", y = "Percentage", fill = "Limit") +
  theme_minimal()

ggplot(data = na.omit(reduced_data), aes(x = city, fill = limit)) +
  geom_bar(position = "fill") + 
  scale_y_continuous(labels = scales::percent) + 
  labs(x = "City", y = "Percentage", fill = "Limit") +
  theme_minimal()

ggplot(data = na.omit(reduced_data), aes(x = caff , y = limit)) + 
  geom_boxplot() +
  labs(x = "Caffeine", y = "Limit")
```





